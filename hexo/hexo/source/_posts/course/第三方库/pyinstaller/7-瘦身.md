---
title: ç¬¬ä¸ƒè®²ï¼šæ•°æ®ç§‘å­¦é¡¹ç›®ä¸“åœº â€”â€” æŠŠ 500 MB çš„ Numpy / Pandas / PyTorch ç åˆ° 150 MB ä»¥å†…
date: 2025-07-14 07:41:49
tags: [ç¬¬ä¸‰æ–¹åº“,pyinstaller]
---




<p align="center" id='è¿›ç¾¤-banner-AI'>
    <a target="_blank" href='http://www.python4office.cn/wechat-group/'>
    <img src="https://raw.atomgit.com/user-images/assets/5027920/87fc1ca4-1a6c-47b8-b234-3e323a1aa827/aiq.jpg" width="100%"/>
    </a>   
</p>

<p align="center">
	ğŸ‘‰ <a target="_blank" href="https://www.python-office.com/">é¡¹ç›®å®˜ç½‘ï¼šhttps://www.python-office.com/</a> ğŸ‘ˆ
</p>
<p align="center">
	ğŸ‘‰ <a target="_blank" href="http://www.python4office.cn/wechat-group/">æœ¬å¼€æºé¡¹ç›®çš„äº¤æµç¾¤</a> ğŸ‘ˆ
</p>



<p align="center" name="atomgit">
  <a target="_blank" href='https://github.com/CoderWanFeng/python-office'>
    <img src="https://img.shields.io/github/stars/CoderWanFeng/python-office.svg?style=social" alt="github star"/>
    </a>
    	<a target="_blank" href='https://gitee.com/CoderWanFeng//python-office/'>
		<img src='https://gitee.com/CoderWanFeng//python-office/badge/star.svg?theme=dark' alt='gitee star'/>
	</a>
	<a target="_blank" href='https://atomgit.com/CoderWanFeng1/python-office'>
		<img src='https://atomgit.com/CoderWanFeng1/python-office/star/2025top.svg?theme=dark' alt='atomgit star'/>
	</a>	
</p>
<p align="center" name="atomgit">
	<a href="https://mp.weixin.qq.com/s/uxCILtn9cfIsJR8PqOxlGQ">
  <img src="https://img.shields.io/badge/å­¦ä¹ -AIç¼–ç¨‹-red" alt="AIç¼–ç¨‹">
</a>
    	<a href="http://www.python4office.cn/wechat-group/">
  <img src="https://img.shields.io/badge/åŠ å…¥-AIäº¤æµç¾¤-brightgreen" alt="AIäº¤æµç¾¤">
</a>

</p>

<!-- more -->



å¤§å®¶å¥½ï¼Œè¿™é‡Œæ˜¯ç¨‹åºå‘˜æ™šæ«ï¼Œæ­£åœ¨all in [AIç¼–ç¨‹å®æˆ˜](https://mp.weixin.qq.com/s/uxCILtn9cfIsJR8PqOxlGQ)ï¼Œå…¨ç½‘åŒåã€‚



--------------------------------------------------
å¼€åœº 30 ç§’  
â€œä¸€ä¸ª `import torch` ç›´æ¥è®©å¯æ‰§è¡Œæ–‡ä»¶è†¨èƒ€åˆ° 1 GBï¼Ÿâ€  
æœ¬è®² 20 åˆ†é’Ÿï¼Œæ•™ä½ ç”¨ 4 æŠŠæ‰‹æœ¯åˆ€ï¼šæ’é™¤ã€è£å‰ªã€æ›¿æ¢ã€å»¶è¿ŸåŠ è½½ï¼ŒæŠŠå¸¸è§ DS æ ˆç˜¦èº« 70 % ä»¥ä¸Šï¼Œå¹¶ç»™å‡ºä¸€å¥—å¯å¤åˆ¶ç²˜è´´çš„ `.spec` æ¨¡æ¿ã€‚

--------------------------------------------------
7.1 ä½“ç§¯å…ƒå‡¶æ’è¡Œæ¦œï¼ˆå…ˆè®¤æ¸…æ•Œäººï¼‰

| åŒ… | è£¸ä½“ç§¯ | ä¸»è¦è‚¥è‚‰ | å¯è£å‰ª % |
|---|---|---|---|
| PyTorch (GPU) | 1.2 GB | CUDA åº“ã€MKLã€debug symbols | 70 % |
| TensorFlow | 500 MB | XLAã€protobufã€avx512 æŒ‡ä»¤ | 60 % |
| Pandas | 100 MB | æµ‹è¯•é›†ã€compatã€json table | 40 % |
| scikit-learn | 30 MB | testsã€docã€æœªç”¨ç®—æ³• | 30 % |
| Numpy | 20 MB | testsã€f2pyã€docs | 20 % |

--------------------------------------------------
7.2 æ‰‹æœ¯åˆ€ 1ï¼šexclude-moduleï¼ˆ2 minï¼‰

.spec ç‰‡æ®µ
```python
a = Analysis(
    ...
    excludes=[
        'matplotlib', 'seaborn',               # å¦‚æœåªæ˜¯ CLI
        'sklearn.tests', 'pandas.tests',        # æµ‹è¯•æ–‡ä»¶
        'torch.cuda', 'torch.distributions',    # ç”¨ä¸åˆ°çš„å­åŒ…
    ],
)
```
ç»éªŒï¼šç”¨ `--collect-submodules torch` æ‰“å°å­åŒ…ï¼ŒæŒ‰éœ€å‰”é™¤ã€‚

--------------------------------------------------
7.3 æ‰‹æœ¯åˆ€ 2ï¼šæ›¿æ¢è½»é‡è½®å­ï¼ˆ3 minï¼‰

| åœºæ™¯ | åŸåŒ… | è½»é‡æ›¿ä»£ | ä½“ç§¯å·® |
|---|---|---|---|
| çº¯ CPU æ¨ç† | torch | torch-cpu (pip install torch==2.1.0+cpu) | -800 MB |
| çŸ©é˜µè®¡ç®— | numpy+mkl | numpy+openblas | -15 MB |
| æ•°æ®è¯»å†™ | pandas | polars / pyarrow | -50 % |
| åºåˆ—åŒ– | joblib | pickle5 / orjson | -5 MB |

`requirements-build.txt` ç¤ºä¾‹
```
--extra-index-url https://download.pytorch.org/whl/cpu
torch==2.1.0+cpu
numpy==1.25.2
polars==0.19
```

--------------------------------------------------
7.4 æ‰‹æœ¯åˆ€ 3ï¼šæŒ‰éœ€åŠ¨æ€åŠ è½½ï¼ˆå»¶è¿ŸåŠ è½½ï¼‰

æ€è·¯ï¼šæŠŠå¯é€‰ç®—æ³•åŒ…æ”¾åœ¨å­è¿›ç¨‹æˆ–æ’ä»¶ç›®å½•ï¼Œä¸»ç¨‹åºå¯åŠ¨åå† `importlib.import_module`ã€‚  
.spec ä»…æ‰“åŒ…ä¸»é“¾è·¯ï¼Œæ’ä»¶ç›®å½•ç”¨ `--add-data` å¸¦è¿‡å»ï¼Œå¯åŠ¨æ—¶æŒ‰éœ€ `pip install --no-deps --target plugins/`ã€‚

--------------------------------------------------
7.5 æ‰‹æœ¯åˆ€ 4ï¼šstrip & UPX ç»„åˆï¼ˆ2 minï¼‰

.spec ç‰‡æ®µ
```python
exe = EXE(
    ...
    strip=True,          # å»æ‰ç¬¦å·è¡¨ï¼ˆLinux/macOSï¼‰
    upx=True,
    upx_exclude=[
        'libtorch.so',   # å‹ç¼©åå¶å‘ SIGILL
        'libiomp5.so',
    ],
)
```
å®æµ‹ Linux å¯å†å‡ 20 %ã€‚

--------------------------------------------------
7.6 å®æˆ˜ï¼šPyTorch CPU + Pandas CLI æ‰“åŒ…å…¨è¿‡ç¨‹ï¼ˆ8 minï¼‰

1. ç¯å¢ƒ  
```bash
python -m venv venv && source venv/bin/activate
pip install -r requirements-build.txt
```

2. ä¸»ç¨‹åºï¼ˆæç®€æ¨ç†è„šæœ¬ï¼‰
```python
# predict.py
import torch, pandas as pd, sys, pathlib
model = torch.jit.load('model.pt')
df = pd.read_csv(sys.argv[1])
pred = model(torch.tensor(df.values)).numpy()
pd.DataFrame(pred).to_csv('out.csv', index=False)
```

3. æ£€æŸ¥å­æ¨¡å—ï¼ˆé˜²æ­¢è¯¯æ€ï¼‰
```bash
python -c "import torch, pkgutil; print([m for m in pkgutil.iter_modules(torch.__path__)])"
```

4. .spec æ¨¡æ¿
```python
# -*- mode: python -*-
import pathlib
SRC = pathlib.Path('.').resolve()

a = Analysis(
    ['predict.py'],
    pathex=[SRC],
    binaries=[],
    datas=[('model.pt', '.')],
    hiddenimports=['torch.jit'],
    excludes=[
        'torch.cuda',
        'torch.distributions',
        'torch.testing',
        'pandas.tests',
    ],
)

pyz = PYZ(a.pure, a.zipped_data)

exe = EXE(
    pyz, a.scripts, a.binaries, a.zipfiles, a.datas,
    name='PredictCLI',
    debug=False,
    console=True,
    strip=True,
    upx=True,
    upx_exclude=['libtorch.so'],
)
```

5. æ‰“åŒ…
```bash
pyinstaller predict.spec
```
ç»“æœï¼š  
- åŸ PyTorch GPU 1.2 GB â†’ æœ€ç»ˆå•æ–‡ä»¶ 145 MB  
- è¿è¡ŒéªŒè¯  
```bash
./dist/PredictCLI sample.csv   # è¾“å‡º out.csv
```

--------------------------------------------------
7.7 è¿›é˜¶ï¼šTorchScript + åˆ å‡ç®—å­ï¼ˆå¯é€‰ï¼‰

å¦‚æœåªç”¨ 10 ä¸ªç®—å­ï¼Œå¯  
```python
import torch.utils.bundled_inputs
torch.utils.bundled_inputs.bundle_inputs(...)
```
ç¼–è¯‘æ—¶è£å‰ªæœªç”¨ç®—å­ï¼Œå¯å†å‡ 30 %ã€‚æ­¤æ­¥éª¤éœ€ C++ ç¯å¢ƒï¼Œç•™ä½œå½©è›‹ã€‚

--------------------------------------------------
7.8 å¸¸è§é”™è¯¯é€ŸæŸ¥

| é”™è¯¯ | åŸå›  | è§£å†³ |
|---|---|---|
| `Illegal instruction (core dumped)` | CPU æŒ‡ä»¤é›†ä¸åŒ¹é… | ç”¨ `torch-cpu` æˆ– `--cpu-baseline=avx2` |
| `libgomp.so.1: cannot open shared object file` | ç¼ºå¤± OpenMP | Linux æ‰“åŒ…æ—¶ `--add-binary "/usr/lib/x86_64-linux-gnu/libgomp.so.1:."` |
| Windows æŠ¥ `numpy.core._exceptions._ArrayMemoryError` | 32 ä½ Python | å¼ºåˆ¶ 64 ä½è§£é‡Šå™¨ |

--------------------------------------------------
å°ç»“ & ä½œä¸šï¼ˆ30 ç§’ï¼‰

â€¢ 4 æŠŠåˆ€ï¼šexcludeã€æ›¿æ¢ã€å»¶è¿Ÿã€strip+UPX  
â€¢ æä¾›å¯å¤åˆ¶çš„ `.spec` æ¨¡æ¿ï¼Œå®æµ‹ 145 MB å®Œæˆ PyTorch æ¨ç†  
â€¢ ä½œä¸šï¼šæŠŠä½ çš„è®­ç»ƒè„šæœ¬æŒ‰æœ¬è®²æ€è·¯ç˜¦èº«ï¼Œä¸‹èŠ‚è¯¾ã€Šç¬¬å…«è®²ï¼šCI/CD è·¨å¹³å°æ‰“åŒ…ã€‹ä¸€é”®æ¨é€åˆ° GitHub Releaseã€‚


----

å¤§å®¶åœ¨å­¦ä¹ è¯¾ç¨‹ä¸­æœ‰ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿+å¾®ä¿¡å’Œæˆ‘äº¤æµğŸ‘‰[æˆ‘çš„è”ç³»æ–¹å¼ï¼šå¾®ä¿¡ã€è¯»è€…ç¾¤ã€1å¯¹1ã€ç¦åˆ©](http://www.python4office.cn/wechat-qrcode/)


![](https://cos.python-office.com/ads/gzh/sub-py.jpg)

![æ‰«ä¸€æ‰«ï¼Œé¢†çº¢åŒ…](https://raw.atomgit.com/user-images/assets/5027920/fad13012-c22f-4c3a-b56e-c70787a55699/172ca166340cd6d0f52d356402901d4f.jpg '6152d8017a3595256e51cbd9e08e148b.png')
  
![ç¾å›¢çº¢åŒ…](https://raw.atomgit.com/user-images/assets/5027920/6aa9a60e-bb4a-423c-a75d-cbd6ecf6f370/4dbea2fec93c415c75311666f19a1022.jpg '6d283319df13b09a3f74a9f19bf18a97.jpg')







ç¨‹åºå‘˜æ™šæ«ä¸“æ³¨AIç¼–ç¨‹åŸ¹è®­ï¼Œå°ç™½çœ‹å®Œä»–çš„æ•™ç¨‹[ã€Š30è®² Â· AIç¼–ç¨‹è®­ç»ƒè¥ã€‹](https://mp.weixin.qq.com/s/uxCILtn9cfIsJR8PqOxlGQ)å°±èƒ½ä¸Šæ‰‹åšAIé¡¹ç›®ã€‚