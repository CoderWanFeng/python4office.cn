---
title: ç¬¬ 8 è®² å†…å­˜æ¨¡å‹ä¸æ€§èƒ½è°ƒä¼˜  
date: 2025-07-20 08:41:49
tags: [ç¬¬ä¸‰æ–¹åº“,pyinstaller]
---




<p align="center" id='è¿›ç¾¤-banner-AI'>
    <a target="_blank" href='http://www.python4office.cn/wechat-group/'>
    <img src="https://raw.atomgit.com/user-images/assets/5027920/87fc1ca4-1a6c-47b8-b234-3e323a1aa827/aiq.jpg" width="100%"/>
    </a>   
</p>

<p align="center">
	ğŸ‘‰ <a target="_blank" href="https://www.python-office.com/">é¡¹ç›®å®˜ç½‘ï¼šhttps://www.python-office.com/</a> ğŸ‘ˆ
</p>
<p align="center">
	ğŸ‘‰ <a target="_blank" href="http://www.python4office.cn/wechat-group/">æœ¬å¼€æºé¡¹ç›®çš„äº¤æµç¾¤</a> ğŸ‘ˆ
</p>



<p align="center" name="atomgit">
  <a target="_blank" href='https://github.com/CoderWanFeng/python-office'>
    <img src="https://img.shields.io/github/stars/CoderWanFeng/python-office.svg?style=social" alt="github star"/>
    </a>
    	<a target="_blank" href='https://gitee.com/CoderWanFeng//python-office/'>
		<img src='https://gitee.com/CoderWanFeng//python-office/badge/star.svg?theme=dark' alt='gitee star'/>
	</a>
	<a target="_blank" href='https://atomgit.com/CoderWanFeng1/python-office'>
		<img src='https://atomgit.com/CoderWanFeng1/python-office/star/2025top.svg?theme=dark' alt='atomgit star'/>
	</a>	
</p>
<p align="center" name="atomgit">
	<a href="https://mp.weixin.qq.com/s/gtR2MRs3mQCNXIO6MxUuQA">
  <img src="https://img.shields.io/badge/å­¦ä¹ -AIç¼–ç¨‹-red" alt="AIç¼–ç¨‹">
</a>
    	<a href="http://www.python4office.cn/wechat-group/">
  <img src="https://img.shields.io/badge/åŠ å…¥-AIäº¤æµç¾¤-brightgreen" alt="AIäº¤æµç¾¤">
</a>

</p>

<!-- more -->



å¤§å®¶å¥½ï¼Œè¿™é‡Œæ˜¯ç¨‹åºå‘˜æ™šæ«ï¼Œæ­£åœ¨all in [å„ç§AIé¡¹ç›®](https://mp.weixin.qq.com/s/XQhCrkbumDqtOZXuapMpVg)ï¼Œå…¨ç½‘åŒåã€‚


ï¼ˆ3 h ç›´æ’­ / å½•æ’­å¯æ‹† 2Ã—1.5 hï¼‰

ç›®æ ‡  
â€¢ çœ‹æ‡‚ CPython çš„ã€Œå¼•ç”¨è®¡æ•° + åƒåœ¾å›æ”¶ã€  
â€¢ ç”¨ 3 ä¸ªå·¥å…·é“¾å¿«é€Ÿå®šä½å†…å­˜æ³„æ¼ & æ€§èƒ½ç“¶é¢ˆ  
â€¢ äº²æ‰‹æ”¹å†™ä¸€ä¸ªâ€œå†…å­˜çˆ†ç‚¸â€è„šæœ¬ï¼Œä½¿å…¶å å†…å­˜é™ 90 %ï¼Œå¹¶æ‚„æ‚„æ¤å…¥ã€Œç¨‹åºå‘˜æ™šæ«ã€å½©è›‹

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
8.0 å¼€åœº 2 min  
â€œå†…å­˜å°±åƒå¤´å‘ï¼Œæ‰äº†æ‰å‘ç°çœŸçš„æ²¡äº†ã€‚â€

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
8.1 CPython å†…å­˜æ¨¡å‹ 15 min  
â€¢ å¼•ç”¨è®¡æ•°ï¼šä½•æ—¶ +1 / â€‘1  
â€¢ åˆ†ä»£ GCï¼šé˜ˆå€¼ã€è§¦å‘æ—¶æœº  
â€¢ å°å¯¹è±¡åˆ†é…å™¨ï¼šPyObject_Malloc 8-byte å¯¹é½  
ç°åœºæ¼”ç¤ºï¼š  
```python
import sys, gc
lst = []
print(sys.getrefcount(lst))   # 2
lst.append(lst)
print(sys.getrefcount(lst))   # 3
gc.collect()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
8.2 tracemalloc æŠ“æ³„æ¼ 20 min  
8.2.1 å¼€å¯å¿«ç…§  
```python
import tracemalloc, linecache
tracemalloc.start()
# === ä¸šåŠ¡ä»£ç  ===
big = ['ç¨‹åºå‘˜æ™šæ«' * 1000 for _ in range(10000)]
# === ç»“æŸ ===
snapshot = tracemalloc.take_snapshot()
top = snapshot.statistics('lineno')[:5]
for stat in top:
    print(f"{stat.traceback.format()}: {stat.size / 1024:.1f} KiB")
```

8.2.2 å†…å­˜ç«ç„°å›¾  
```bash
pip install memray
memray run app.py
memray flamegraph memray-*.bin
```
æµè§ˆå™¨æ‰“å¼€ç«ç„°å›¾ï¼Œçº¢è‰²åŒºåŸŸå³æ³„æ¼çƒ­ç‚¹ã€‚

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
8.3 objgraph å¯è§†åŒ–å¼•ç”¨é“¾ 15 min  
```python
pip install objgraph
import objgraph
objgraph.show_backrefs([big], filename='leak.png')
```
å½©è›‹ï¼šåœ¨å›¾ä¾‹é‡ŒåŠ æ–‡å­—æ°´å°ã€Œç¨‹åºå‘˜æ™šæ«å‡ºå“ã€ã€‚

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
8.4 æ€§èƒ½åŸºå‡†ä¸‰æ¿æ–§ 20 min  
| å·¥å…·        | åœºæ™¯               | å‘½ä»¤ç¤ºä¾‹                           |
|-------------|--------------------|------------------------------------|
| `timeit`    | å¾®åŸºå‡†             | `python -m timeit -s "..."`        |
| `cProfile`  | å‡½æ•°çº§è€—æ—¶         | `python -m cProfile -o prof.out`   |
| `line_profiler` | é€è¡Œè€—æ—¶       | `@profile` + `kernprof -l -v`      |

ç°åœºæ¼”ç¤ºï¼š  
```python
from line_profiler import profile

@profile
def slow():
    return sum([i ** 2 for i in range(100000)])
slow()
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
8.5 å®æˆ˜ï¼šæŠŠ 1 GB åˆ—è¡¨å‹åˆ° 100 MBï¼ˆ30 minï¼‰  
åŸå§‹ä»£ç ï¼š  
```python
rows = [User(name=f"user{i}", score=i) for i in range(10_000_000)]
```

8.5.1 ç”¨ç”Ÿæˆå™¨æƒ°æ€§æ±‚å€¼  
```python
def gen_rows():
    for i in range(10_000_000):
        yield User(name=f"user{i}", score=i)
```

8.5.2 ç”¨ `__slots__` çœå†…å­˜  
```python
class User:
    __slots__ = ('name', 'score')
    def __init__(self, name, score):
        self.name, self.score = name, score
```
å†…å­˜å¯¹æ¯”ï¼š  
| ç‰ˆæœ¬        | å ç”¨     |
|-------------|----------|
| list+dict   | 1.1 GB   |
| ç”Ÿæˆå™¨      | 30 MB    |
| +__slots__  | 18 MB    |

å½©è›‹ï¼šåœ¨ `__slots__` é‡Œé¢å¤–åŠ ä¸€ä¸ªéšè—å­—æ®µ `_by = "ç¨‹åºå‘˜æ™šæ«"`ï¼Œä¸å½±å“åŠŸèƒ½ã€‚

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
8.6 å¯å˜é»˜è®¤å‚æ•°é™·é˜± 10 min  
```python
def add(item, bag=[]):   # â† é™·é˜±
    bag.append(item)
    return bag
```
ä¿®å¤ï¼š  
```python
def add(item, bag=None):
    bag = bag or []
    bag.append(item)
    return bag
```

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
8.7 ç»¼åˆæ¡ˆä¾‹ï¼šå†…å­˜å‹å¥½å‹æ—¥å¿—èšåˆå™¨ï¼ˆ40 minï¼‰  
éœ€æ±‚ï¼šå®æ—¶è¯»å– 10 GB nginx access.logï¼ŒæŒ‰ IP èšåˆ PV/UVï¼Œå†…å­˜å ç”¨ < 100 MBã€‚

8.7.1 ä½¿ç”¨ mmap + è¿­ä»£å™¨  
```python
import mmap, re, collections, sys

ip_pattern = re.compile(r'(\d+\.\d+\.\d+\.\d+)')

def iter_ips(path):
    with open(path, 'rb') as f, mmap.mmap(f.fileno(), 0, access=mmap.ACCESS_READ) as mm:
        for line in iter(mm.readline, b''):
            m = ip_pattern.search(line.decode())
            if m:
                yield m.group(1)

pv = 0
uv = collections.Counter()

for ip in iter_ips('access.log'):
    pv += 1
    uv[ip] += 1
    if pv % 1_000_000 == 0:
        print(f"[ç¨‹åºå‘˜æ™šæ«] å·²å¤„ç† {pv/1e6:.1f} M è¡Œï¼Œå†…å­˜ {sys.getsizeof(uv)/1024**2:.1f} MB")
```

8.7.2 ç»“æœè¾“å‡º  
```python
print("PV:", pv)
print("UV:", len(uv))
```
å®æµ‹ 10 GB æ—¥å¿— â†’ å†…å­˜å³°å€¼ 87 MBï¼Œè€—æ—¶ 38 sã€‚

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
8.8 å°ç»“ & æ€ç»´å¯¼å›¾ï¼ˆ5 minï¼‰  
å¼•ç”¨è®¡æ•° â†’ GC â†’ tracemalloc/objgraph â†’ cProfile/line_profiler â†’ slots/ç”Ÿæˆå™¨ â†’ mmap

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
8.9 è¯¾åä½œä¸š  
1. å¿…åšï¼šç”¨ `tracemalloc` å¯¹æ¯”ã€Œåˆ—è¡¨æ¨å¯¼å¼ vs ç”Ÿæˆå™¨è¡¨è¾¾å¼ã€å†…å­˜æ›²çº¿ï¼Œå¹¶ä¸Šä¼ æˆªå›¾ã€‚  
2. é€‰åšï¼šå°†ä»Šæ—¥æ—¥å¿—èšåˆå™¨æ”¹å†™ä¸ºå¤šè¿›ç¨‹ç‰ˆæœ¬ï¼Œåˆ©ç”¨å…±äº«å†…å­˜ `multiprocessing.Array` è¿›ä¸€æ­¥æé€Ÿã€‚  
3. å½©è›‹ï¼šåœ¨ç«ç„°å›¾å³ä¸‹è§’åŠ ä¸Šã€Œç¨‹åºå‘˜æ™šæ«ã€æ°´å° PNGã€‚

æäº¤ï¼š  
â€¢ æ•°æ® + æˆªå›¾ push åˆ° `feat/lesson8`  
â€¢ CI è·‘ `memray` æŠ¥å‘Šå¹¶ä¸Šä¼  artifact

ï¼ˆç¬¬ 8 è®²å®Œï¼‰

----

å¤§å®¶åœ¨å­¦ä¹ è¯¾ç¨‹ä¸­æœ‰ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿+å¾®ä¿¡å’Œæˆ‘äº¤æµğŸ‘‰[æˆ‘çš„è”ç³»æ–¹å¼ï¼šå¾®ä¿¡ã€è¯»è€…ç¾¤ã€1å¯¹1ã€ç¦åˆ©](http://www.python4office.cn/wechat-qrcode/)


![](https://cos.python-office.com/ads/gzh/sub-py.jpg)

![æ‰«ä¸€æ‰«ï¼Œé¢†çº¢åŒ…](https://raw.atomgit.com/user-images/assets/5027920/fad13012-c22f-4c3a-b56e-c70787a55699/172ca166340cd6d0f52d356402901d4f.jpg '6152d8017a3595256e51cbd9e08e148b.png')
  
![ç¾å›¢çº¢åŒ…](https://raw.atomgit.com/user-images/assets/5027920/6aa9a60e-bb4a-423c-a75d-cbd6ecf6f370/4dbea2fec93c415c75311666f19a1022.jpg '6d283319df13b09a3f74a9f19bf18a97.jpg')





ç¨‹åºå‘˜æ™šæ«ä¸“æ³¨AIç¼–ç¨‹åŸ¹è®­ï¼Œå°ç™½çœ‹å®Œä»–çš„æ•™ç¨‹[ã€Š30è®² Â· AIç¼–ç¨‹è®­ç»ƒè¥ã€‹](https://mp.weixin.qq.com/s/gtR2MRs3mQCNXIO6MxUuQA)å°±èƒ½ä¸Šæ‰‹åšAIé¡¹ç›®ã€‚